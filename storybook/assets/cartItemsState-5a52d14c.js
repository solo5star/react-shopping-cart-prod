import{j as d,c as l,B as S,i as m,e as f,b as u,d as y}from"./environment-eafc0253.js";const w=[200,201,202,203,204,205,206,207,208,226,300,301,302,303,304,307,308];class g{get data(){return this.response.data}get headers(){return this.response.headers}get statusCode(){return this.response.statusCode}constructor(t){this.response=t}assertStatusCode(t,e){return(Array.isArray(e)?e:[e]).includes(t.statusCode)}accept(t){const{response:e}=this;return this.assertStatusCode(e,t)?e:null}acceptOrThrow(t){const{response:e}=this;if(!this.assertStatusCode(e,t))throw this;return e}acceptOkOrThrow(){return this.acceptOrThrow(w)}}class C{constructor(t,...e){this.internalQueryParams=null,this.path=t,this.internalParams=e}queryParams(t){return this.internalQueryParams=t,this}toString(){const t=[...this.internalParams],e=this.path.split("/").map(n=>n.startsWith(":")?t.shift():n).join("/"),s=Object.keys(this.internalQueryParams??{}).length===0?"":`?${new URLSearchParams(this.internalQueryParams??{}).toString()}`;return e+s}}class E{constructor(t={}){this.options=t}getUrl(t){return d(this.options.base??"",t)}async parseResponseData(t){try{return await t.json()}catch{return null}}toJSON(){return this.options}clone(t){return Object.assign(Object.create(Object.getPrototypeOf(this)),this,{options:{...this.options,...t}})}withAuthorization(t){return this.clone({authorization:t})}async fetch(t,e,s){const{authorization:n}=this.options,a=await fetch(this.getUrl(e.toString()),{method:t,...s,headers:{"Content-Type":"application/json; charset=UTF-8",...n?{Authorization:`Basic ${btoa(`${n.username}:${n.password}`)}`}:{},...s==null?void 0:s.headers}});return new g({statusCode:a.status,data:await this.parseResponseData(a),headers:Object.fromEntries(a.headers.entries())})}get(t,e){return this.fetch("GET",t,e)}post(t,e,s){return this.fetch("POST",t,{...s,headers:{"Content-Type":"application/json",...s==null?void 0:s.headers},body:JSON.stringify(e)})}patch(t,e,s){return this.fetch("PATCH",t,{headers:{"Content-Type":"application/json",...s==null?void 0:s.headers},body:JSON.stringify(e),...s})}delete(t,e){return this.fetch("DELETE",t,e)}path(t,...e){return new C(t,...e)}}class U extends E{}const D=l({key:"authorizationState",default:null}),O="[MSW]/api,[주드]https://shopping-cart-1.solo5star.com,[키아라]https://shopping-cart-2.solo5star.com,[히이로]https://shopping-cart-3.solo5star.com",R=r=>{const t=/^(?:\[(?<name>[가-힣\w\d_-]+)\])?(?<base>(?<protocol>https?:\/\/)?.+)$/.exec(r);if(t===null||t.groups===void 0)throw new Error(`"${r}"은 올바르지 않은 API_URL입니다. "[name]주소" 형식으로 입력해야 합니다.`);const{name:e,base:s,protocol:n}=t.groups;if(!s)throw new Error(`"${s}"은 올바르지 않은 URL입니다.`);return{name:e,base:n?s:d(S,s)}},T=O.split(",").map(R),v=m({key:"serverState",default:T[0]}),j=f({key:"clientState",get:({get:r})=>{const t=r(v),e=r(D(t));return new U({base:t.base,authorization:e})}}),p=u({key:"cartItemsQuery",get:({client:r})=>()=>r.get("/cart-items")});class P{constructor(t,e,s){this.dirtyUpdates=[],this.upstreamSync=null,this.downstreamSync=null,this.errorHandler=null,this.conflictHandler=null,this.client=t,this.clientState=e,this.remoteState=s}set(t){this.dirtyUpdates.push(t),this.flushDirtyUpdates()}hasDirtyUpdate(){return this.dirtyUpdates.length>0}isSynchronizing(){return this.upstreamSync||this.downstreamSync}async waitForSync(){for(;this.upstreamSync||this.downstreamSync;)await this.upstreamSync,await this.downstreamSync}enqueueDownstreamSync(t){if(this.dirtyUpdates=[],t instanceof Promise){this.downstreamSync=t,this.downstreamSync.then(e=>{this.downstreamSync=null,this.remoteState=e,this.flushDirtyUpdates()});return}this.remoteState=t}enqueueUpstreamSync(t,e){this.upstreamSync=t,this.upstreamSync.then(s=>{var n;this.remoteState=s,this.upstreamSync=null,this.stateEquals(e,this.remoteState)||(n=this.conflictHandler)==null||n.call(this,e,this.remoteState),this.flushDirtyUpdates()})}flushDirtyUpdates(){if(!this.hasDirtyUpdate()||this.isSynchronizing())return;const t=(this.dirtyUpdates??[]).reduce((s,n)=>typeof n=="function"?n(s):n,this.clientState);this.dirtyUpdates=[],this.clientState=structuredClone(t);const e=this.syncToRemote();e!==null&&this.enqueueUpstreamSync(e,t)}onError(t){this.errorHandler=t}onConflict(t){this.conflictHandler=t}clear(){this.errorHandler=null,this.conflictHandler=null}}class b extends P{constructor(t,e,s,n){super(e,s,n),this.productId=t}stateEquals(t,e){return(t==null?void 0:t.checked)===(e==null?void 0:e.checked)&&(t==null?void 0:t.quantity)===(e==null?void 0:e.quantity)}syncToRemote(){if(this.clientState===null)return this.remoteState!==null?this.client.delete(this.client.path("/cart-items/:cartItemId",this.remoteState.id)).then(s=>s.acceptOrThrow(204)).then(()=>null):null;const{product:t}=this.clientState;if(this.remoteState===null)return this.client.post("/cart-items",{productId:t.id}).then(s=>s.acceptOrThrow(201)).then(s=>({id:Number(s.headers.location.split("/").pop()),product:t,...s.data}));if(this.remoteState.checked===this.clientState.checked&&this.remoteState.quantity===this.clientState.quantity)return null;const{id:e}=this.remoteState;return this.client.patch(this.client.path("/cart-items/:cartItemId",e),{quantity:this.clientState.quantity,checked:this.clientState.checked}).then(s=>s.acceptOrThrow(200)).then(s=>({id:e,product:t,...s.data}))}}const H=3e4;class _{constructor(t,e={syncInterval:H}){this.syncStates=new Map,this.changeByDownstreamHandler=null,this.syncHandler=null,this.sync=null,this.options=e,this.client=t,this.syncIntervalHandler=setInterval(()=>this.doDownstreamSync(),this.options.syncInterval)}setFromRemote(t){t.forEach(e=>{this.createState(e.product.id,e,e).set(e)}),this.fireSyncEvent(t)}createState(t,e,s){const n=new b(t,this.client,e??null,s??null);return this.syncStates.set(t,n),n.onError(()=>this.doDownstreamSync()),n.onConflict((a,o)=>{this.resolveConflict(t,o)}),n}resolveConflict(t,e){var s;(s=this.changeByDownstreamHandler)==null||s.call(this,n=>e===null?n.filter(a=>a.product.id!==t):n.map(a=>a.product.id!==t?a:{...a,expectedCartItem:e}))}setFromClient(t){this.syncStates.forEach((e,s)=>{!t.some(a=>a.product.id===s)&&e.set(null)}),t.forEach(e=>{const s=this.syncStates.get(e.product.id);if(s){s.set(e);return}const n=this.createState(e.product.id);n.set(e),this.syncStates.set(e.product.id,n)}),this.fireSyncEvent(t)}async fireSyncEvent(t){var e;this.sync===null&&((e=this.syncHandler)==null||e.call(this,{isSynchronizing:!0}),this.sync=this.waitForSync().then(()=>t.map(s=>{var n;return(n=this.syncStates.get(s.product.id))==null?void 0:n.remoteState}).filter(s=>!!s)),this.sync.then(s=>{var n;(n=this.syncHandler)==null||n.call(this,{cartItems:s,isSynchronizing:!1}),this.sync=null}))}reset(){this.syncStates.forEach(t=>{t.set(null),t.clear()})}async doDownstreamSync(){var e;const t=await this.client.get("/cart-items").then(s=>s.acceptOrThrow(200).data);this.syncStates.forEach(s=>s.enqueueDownstreamSync(t.find(n=>n.product.id===s.productId)??null)),(e=this.changeByDownstreamHandler)==null||e.call(this,()=>t)}async waitForSync(){for(;[...this.syncStates.values()].some(t=>t.isSynchronizing());)await Promise.all([...this.syncStates.values()].filter(t=>t.isSynchronizing()).map(t=>t.waitForSync()))}clear(){clearInterval(this.syncIntervalHandler),this.syncStates.clear()}onChangeByDownstream(t){this.changeByDownstreamHandler=t}onSync(t){this.syncHandler=t}}const k=l({key:"remoteCartItemsStorageState",default:r=>new _(r),dangerouslyAllowMutability:!0}),q=r=>({onSet:t,setSelf:e,getPromise:s})=>{const n=s(k(r));return n.then(a=>{a.onChangeByDownstream(o=>e(i=>i instanceof y?i:o(i)))}),s(p({client:r})).then(a=>{const o=a.acceptOrThrow(200).data;n.then(i=>{i.setFromRemote(o)})}),t((a,o,i)=>{if(i){n.then(c=>c.reset());return}n.then(c=>c.setFromClient(a))}),()=>n.then(a=>a.clear())},h=l({key:"internalCartItemsState",default:u({key:"internalCartItemsState/default",get:r=>({get:t})=>t(p({client:r})).acceptOrThrow(200).data}),effects:r=>[q(r)]}),z=u({key:"cartItemsState",get:r=>({get:t})=>t(h(r)),set:r=>({set:t,reset:e},s)=>{if(s instanceof y){e(h(r));return}const n=s.filter(a=>a.quantity>0);t(h(r),n)}});export{j as a,z as b,p as c,D as d,T as e,k as r,v as s};
//# sourceMappingURL=cartItemsState-5a52d14c.js.map

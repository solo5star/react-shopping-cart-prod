import{j as _,e as E,a as y,f as P,g as R,h as f}from"./http-4b3419c1.js";const U=s=>({setSelf:t,onSet:e})=>{const r=localStorage.getItem(s);r!==null&&t(JSON.parse(r)),e((n,i,h)=>{if(h){localStorage.removeItem(s);return}localStorage.setItem(s,JSON.stringify(n))})},b=[200,201,202,203,204,205,206,207,208,226,300,301,302,303,304,307,308];class j{constructor(t){this.responsePromise=t()}assertStatusCode(t,e){return(Array.isArray(e)?e:[e]).includes(t.statusCode)}async accept(t){const e=await this.responsePromise;return this.assertStatusCode(e,t)?e:null}async acceptOrThrow(t){const e=await this.responsePromise;if(!this.assertStatusCode(e,t))throw new Error(`Server responses with status code ${e.statusCode}`);return e}async acceptOkOrThrow(){return this.acceptOrThrow(b)}}class v{constructor(t,...e){this.internalQueryParams=null,this.path=t,this.internalParams=e}queryParams(t){return this.internalQueryParams=t,this}toString(){const t=[...this.internalParams],e=this.path.split("/").map(n=>n.startsWith(":")?t.shift():n).join("/"),r=Object.keys(this.internalQueryParams??{}).length===0?"":`?${new URLSearchParams(this.internalQueryParams??{}).toString()}`;return e+r}}class k{constructor(t={}){this.options=t}getUrl(t){return _(this.options.base??"",t)}async parseResponseData(t){try{return await t.json()}catch{return null}}toJSON(){return this.options}setBase(t){this.options.base=t}fetch(t,e,r){return new j(async()=>{const n=await fetch(this.getUrl(e.toString()),{method:t,...r,headers:{"Content-Type":"application/json; charset=UTF-8",Authorization:`Basic ${btoa("a@a.com:1234")}`}});return{statusCode:n.status,data:await this.parseResponseData(n),headers:Object.fromEntries(n.headers.entries())}})}get(t){return this.fetch("GET",t)}post(t,e){return this.fetch("POST",t,{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}patch(t,e){return this.fetch("PATCH",t,{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}delete(t){return this.fetch("DELETE",t)}path(t,...e){return new v(t,...e)}}const F="https://shopping-cart-1.solo5star.com,https://shopping-cart-2.solo5star.com,https://shopping-cart-3.solo5star.com",Q=["주드","키아라","히이로"],A=F.split(",").map((s,t)=>({name:Q[t]??`서버-${t+1}`,base:s})),D=E({key:"serverState",default:A[0]}),S=y({key:"clientState",get:({get:s})=>{const t=s(D);return new k({base:t.base})}}),T=y({key:"cartItemsQuery",get:({get:s})=>s(S).get("/cart-items").acceptOrThrow(200).then(e=>e.data)}),O=[],g=(s,t)=>{const e=O.find(r=>r.client===s&&r.productId===t)??null;if(e==null){const r={client:s,productId:t};return O.push(r),r}return e},w=P({key:"syncCartItemState",default:R({key:"syncCartItemState/default",get:s=>({get:t})=>{const{client:e,productId:r}=s,n=t(T);return{client:e,semaphore:null,state:{productId:r,...n.find(i=>i.product.id===r)},enqueuedUpdates:[]}}}),effects:[({setSelf:s,onSet:t})=>{const e=r=>{const{client:n}=r,i=n.path.bind(n),h=l=>{const d=n.delete(i("/cart-items/:cartItemId",l)).acceptOrThrow(204);return d.finally(()=>s(o=>o instanceof f?o:e({...o,semaphore:null}))),{...r,state:{productId:r.state.productId},semaphore:d,enqueuedUpdates:[]}},a=()=>{const l=n.post("/cart-items",{productId:r.state.productId}).acceptOrThrow(201);return l.then(d=>s(o=>{var p;return o instanceof f?o:e({...o,state:{...o.state,id:Number((p=String(d.headers.location).match(/(\d+)$/))==null?void 0:p.at(0))},semaphore:null})})),{...r,semaphore:l}},c=(l,d)=>{const o=n.patch(i("/cart-items/:cartItemId",l),{quantity:d}).acceptOrThrow(200);return o.finally(()=>s(p=>p instanceof f?p:e({...p,semaphore:null}))),{...r,semaphore:o,state:{...r.state,quantity:d},enqueuedUpdates:[]}};if(r.semaphore!==null)return r;const u=r.enqueuedUpdates.reduce((l,d)=>({...l,...d}),r.state);return"quantity"in u&&u.quantity<=0?"id"in u?h(u.id):r:"quantity"in u?"id"in u?"quantity"in r.state&&r.state.quantity===u.quantity?r:c(u.id,u.quantity):a():r};t(r=>{const n=e(r);n&&s(n)})}]}),m=P({key:"localCartItemsState",default:T}),q=E({key:"unselectedForOrdersState",default:[],effects:[U("unselectedForOrders")]}),J=y({key:"cartItemsState",get:({get:s})=>{const t=s(S),e=s(m(t)),r=s(q);return e.map(n=>({...n,unselectedForOrder:r.includes(n.product.id)}))},set:({get:s,set:t},e)=>{const r=s(S),n=s(m(r));if(e instanceof f)throw new Error("reset of cartItemsState is not implemented!");const i=e.filter(a=>a.quantity>0);t(m(r),i),t(q,i.filter(a=>a.unselectedForOrder).map(a=>a.product.id)),n.filter(a=>i.find(c=>c.product.id===a.product.id)===void 0).forEach(a=>{t(w(g(r,a.product.id)),c=>({...c,enqueuedUpdates:[...c.enqueuedUpdates,{quantity:0}]}))}),i.forEach(a=>{t(w(g(r,a.product.id)),c=>({...c,enqueuedUpdates:[...c.enqueuedUpdates,{quantity:a.quantity}]}))})}});export{A as a,J as c,D as s};
//# sourceMappingURL=cartItemsState-0ef27d27.js.map
